<template>
  <!-- AIÊ®°ÂûãËÆæÁΩÆ‰∏ªÂºπÁ™ó - Âü∫‰∫éMeterSphereÂÆûÁé∞ÔºåËΩ¨Êç¢‰∏∫ÂºπÁ™óÂΩ¢Âºè -->
  <el-dialog
    :visible="visible"
    title="AIÊ®°ÂûãËÆæÁΩÆ"
    width="80%"
    :before-close="handleClose"
    class="model-settings-dialog"
  >
    <div class="h-full w-full">
      <!-- ÂàÜÂâ≤Èù¢ÊùøÔºöÂ∑¶‰æß‰æõÂ∫îÂïÜÂàóË°®ÔºåÂè≥‰æßÊ®°ÂûãÂàóË°® -->
      <div class="model-settings-container">
        <!-- Â∑¶‰æß‰æõÂ∫îÂïÜÂàóË°® -->
        <div class="model-list-wrapper">
          <div class="model-config-title">‰æõÂ∫îÂïÜ</div>
          <div>
            <div
              v-for="item of modelList"
              :key="item.value"
              :class="`model-item flex gap-[8px] rounded ${item.value === activeModelType ? 'active' : ''}`"
              @click="changeModelType(item)"
            >
              <div class="model-item-img h-[24px] w-[24px]">
                <i :class="getModelIcon(item.icon)" />
              </div>
              <div>{{ item.name }}</div>
            </div>
          </div>
        </div>

        <!-- Âè≥‰æßÊ®°ÂûãÈÖçÁΩÆÂå∫Âüü -->
        <div class="model-config-content">
          <div class="p-[16px]">
            <div
              :class="`mb-[16px] flex items-center ${
                hasPermission() ? 'justify-between' : 'justify-end'
              }`"
            >
              <el-button v-if="hasPermission()" type="primary" @click="addModel">
                Ê∑ªÂä†Ê®°Âûã
              </el-button>
              <el-input
                v-model="keyword"
                placeholder="ËØ∑ËæìÂÖ•Ê®°ÂûãÂêçÁß∞ÊêúÁ¥¢"
                class="w-[240px]"
                clearable
                @clear="searchData"
                @input="searchData"
              >
                <template #suffix>
                  <i class="el-icon-search" />
                </template>
              </el-input>
            </div>

            <!-- Ê®°ÂûãÂç°ÁâáÂàóË°® -->
            <div class="model-config-card-list-wrapper">
              <el-scrollbar class="h-full">
                <div v-loading="loading" class="model-config-card-list relative">
                  <div v-if="modelData.length === 0 && !loading" class="empty-state">
                    <p class="text-center text-[var(--color-text-4)]">ÊöÇÊó†Ê®°ÂûãÊï∞ÊçÆ</p>
                  </div>

                  <div v-else class="model-grid">
                    <div
                      v-for="item in modelData"
                      :key="item.id"
                      class="model-card rounded-md bg-white p-[24px]"
                    >
                      <!-- Ê®°ÂûãÂç°ÁâáÂ§¥ÈÉ® -->
                      <div class="model-item-header mb-[16px] flex flex-nowrap items-center gap-[8px]">
                        <div class="model-item-img flex h-[40px] w-[40px] flex-shrink-0 items-center justify-center">
                          <i :class="getModelIcon(getModelSvg(item))" class="text-[24px]" />
                        </div>
                        <div class="one-line-text flex flex-1 flex-col">
                          <el-tooltip :content="item.name" :disabled="item.name.length <= 20">
                            <div class="one-line-text font-medium">{{ item.name }}</div>
                          </el-tooltip>
                          <div class="flex gap-[8px] text-[12px]">
                            <div class="text-[var(--color-text-4)]">ÂàõÂª∫Áî®Êà∑</div>
                            <el-tooltip :content="item.createUserName" :disabled="(item.createUserName || '').length <= 15">
                              <div class="one-line-text">{{ item.createUserName || '-' }}</div>
                            </el-tooltip>
                          </div>
                        </div>
                      </div>

                      <!-- Ê®°ÂûãÂç°ÁâáÂÜÖÂÆπ -->
                      <div class="model-item-body one-line-text flex items-center gap-[8px]">
                        <div class="model-item-body-label flex flex-col gap-[8px] text-[var(--color-text-4)]">
                          <div>Ê®°ÂûãÁ±ªÂûã</div>
                          <div>Âü∫Á°ÄÊ®°Âûã</div>
                        </div>
                        <div class="one-line-text flex flex-col gap-[8px]">
                          <el-tooltip :content="getTypeName(item)" :disabled="getTypeName(item).length <= 20">
                            <div class="one-line-text">{{ getTypeName(item) }}</div>
                          </el-tooltip>
                          <el-tooltip :content="item.baseName" :disabled="(item.baseName || '').length <= 20">
                            <div class="one-line-text">{{ item.baseName || '-' }}</div>
                          </el-tooltip>
                        </div>
                      </div>

                      <!-- Ê®°ÂûãÂç°ÁâáÂ∫ïÈÉ®Êìç‰Ωú -->
                      <div class="model-item-footer mt-[24px] flex items-center justify-between">
                        <div class="flex items-center gap-[12px]">
                          <el-button
                            v-if="hasPermission()"
                            type="primary"
                            size="small"
                            plain
                            @click="editModel(item)"
                          >
                            ÁºñËæë
                          </el-button>
                          <el-button
                            v-if="hasPermission()"
                            type="danger"
                            size="small"
                            plain
                            @click="deleteModel(item)"
                          >
                            Âà†Èô§
                          </el-button>
                        </div>

                        <el-switch
                          :value="item.status"
                          :disabled="!hasPermission()"
                          @change="(val) => changeStatus(val, item)"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </el-scrollbar>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ê®°ÂûãÁºñËæëÊäΩÂ±â -->
    <ModelEditDrawer
      :visible="showModelConfigDrawer"
      :current-model-id="currentModelId"
      :supplier-model-item="supplierModelItem"
      :model-key="'system'"
      @close="handleCancel"
      @refresh="refreshHandler"
      @update:visible="showModelConfigDrawer = $event"
    />
  </el-dialog>
</template>

<script>
import { modelList, modelTypeOptions } from '../../constants/model'
import { getModelSvg, characterLimit } from '../../utils/modelUtils'
import { getModelConfigList, editModelConfig, deleteModelConfig } from '../../api/model'
import ModelEditDrawer from './ModelEditDrawer.vue'

export default {
  name: 'ModelSettingsDialog',
  components: {
    ModelEditDrawer
  },
  props: {
    visible: {
      type: Boolean,
      default: false
    }
  },
  data () {
    return {
      modelList: modelList,
      activeModelType: 'DeepSeek', // ÈªòËÆ§ÈÄâ‰∏≠DeepSeek
      supplierModelItem: modelList[0], // ÂΩìÂâçÈÄâ‰∏≠ÁöÑ‰æõÂ∫îÂïÜ
      keyword: '', // ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
      loading: false,
      modelData: [], // Ê®°ÂûãÊï∞ÊçÆÂàóË°®
      showModelConfigDrawer: false, // ÁºñËæëÊäΩÂ±âÊòæÁ§∫Áä∂ÊÄÅ
      currentModelId: '', // ÂΩìÂâçÁºñËæëÁöÑÊ®°ÂûãID
      pagination: {
        current: 1,
        pageSize: 50,
        total: 0
      }
    }
  },
  created () {
    this.init()
  },
  methods: {
    /**
     * ÂàùÂßãÂåñ
     */
    init () {
      // ËÆæÁΩÆÈªòËÆ§ÈÄâ‰∏≠ÁöÑ‰æõÂ∫îÂïÜ
      this.supplierModelItem = this.modelList[0]
      this.activeModelType = this.modelList[0].value
      this.loadModelData()
    },

    /**
     * Âä†ËΩΩÊ®°ÂûãÊï∞ÊçÆ
     */
    async loadModelData () {
      this.loading = true
      try {
        const params = {
          current: this.pagination.current,
          pageSize: this.pagination.pageSize,
          owner: '', // Á≥ªÁªüÁ∫ßÊ®°ÂûãÔºåowner‰∏∫Á©∫
          keyword: this.keyword,
          providerName: this.activeModelType
        }

        console.log('üîß [ModelSettingsDialog] ÂºÄÂßãÂä†ËΩΩÊ®°ÂûãÊï∞ÊçÆ:', params)
        const response = await getModelConfigList(params)
        console.log('üîß [ModelSettingsDialog] Ê®°ÂûãÊï∞ÊçÆÂìçÂ∫î:', response)

        if (response && response.records) {
          this.modelData = response.records
          this.pagination.total = response.total || 0
        } else {
          this.modelData = []
          this.pagination.total = 0
        }
      } catch (error) {
        console.error('Âä†ËΩΩÊ®°ÂûãÊï∞ÊçÆÂ§±Ë¥•:', error)
        this.$message.error('Âä†ËΩΩÊ®°ÂûãÊï∞ÊçÆÂ§±Ë¥•')
        this.modelData = []
      } finally {
        this.loading = false
      }
    },

    /**
     * ÂàáÊç¢Ê®°Âûã‰æõÂ∫îÂïÜ
     */
    changeModelType (item) {
      this.keyword = ''
      this.activeModelType = item.value
      this.supplierModelItem = item
      this.pagination.current = 1
      this.loadModelData()
    },

    /**
     * ÊêúÁ¥¢Êï∞ÊçÆ
     */
    searchData () {
      this.pagination.current = 1
      this.loadModelData()
    },

    /**
     * Ê∑ªÂä†Ê®°Âûã
     */
    addModel () {
      this.currentModelId = ''
      this.showModelConfigDrawer = true
    },

    /**
     * ÁºñËæëÊ®°Âûã
     */
    editModel (item) {
      this.currentModelId = item.id
      this.showModelConfigDrawer = true
    },

    /**
     * Âà†Èô§Ê®°Âûã
     */
    deleteModel (item) {
      this.$confirm(
        `Á°ÆÂÆöË¶ÅÂà†Èô§Ê®°Âûã "${characterLimit(item.name)}" ÂêóÔºü`,
        'Âà†Èô§Á°ÆËÆ§',
        {
          confirmButtonText: 'Á°ÆËÆ§Âà†Èô§',
          cancelButtonText: 'ÂèñÊ∂à',
          type: 'warning'
        }
      ).then(async () => {
        try {
          await deleteModelConfig(item.id)
          this.$message.success('Âà†Èô§ÊàêÂäü')
          this.loadModelData()
        } catch (error) {
          console.error('Âà†Èô§Ê®°ÂûãÂ§±Ë¥•:', error)
          this.$message.error('Âà†Èô§Ê®°ÂûãÂ§±Ë¥•')
        }
      }).catch(() => {
        // Áî®Êà∑ÂèñÊ∂àÂà†Èô§
      })
    },

    /**
     * ÂàáÊç¢Ê®°ÂûãÁä∂ÊÄÅ
     */
    async changeStatus (newValue, item) {
      const action = newValue ? 'ÂêØÁî®' : 'Á¶ÅÁî®'

      if (!newValue) {
        // Á¶ÅÁî®Êó∂ÈúÄË¶ÅÁ°ÆËÆ§
        try {
          await this.$confirm(
            `Á°ÆÂÆöË¶Å${action}Ê®°Âûã "${characterLimit(item.name)}" ÂêóÔºü`,
            'Áä∂ÊÄÅÁ°ÆËÆ§',
            {
              confirmButtonText: `Á°ÆËÆ§${action}`,
              cancelButtonText: 'ÂèñÊ∂à',
              type: 'warning'
            }
          )
        } catch {
          return // Áî®Êà∑ÂèñÊ∂à
        }
      }

      this.loading = true
      try {
        await editModelConfig({
          ...item,
          status: newValue
        })
        this.$message.success(`${action}ÊàêÂäü`)
        this.loadModelData()
      } catch (error) {
        console.error(`${action}Ê®°ÂûãÂ§±Ë¥•:`, error)
        this.$message.error(`${action}Ê®°ÂûãÂ§±Ë¥•`)
      } finally {
        this.loading = false
      }
    },

    /**
     * ÁºñËæëÊäΩÂ±âÂèñÊ∂à
     */
    handleCancel () {
      this.currentModelId = ''
    },

    /**
     * Âà∑Êñ∞Â§ÑÁêÜ
     */
    refreshHandler () {
      this.loadModelData()
    },

    /**
     * ÂÖ≥Èó≠ÂºπÁ™ó
     */
    handleClose () {
      this.$emit('update:visible', false)
      this.$emit('close')
    },

    /**
     * Ëé∑ÂèñÊ®°ÂûãÂõæÊ†á
     */
    getModelSvg (item) {
      return getModelSvg(item)
    },

    /**
     * Ëé∑ÂèñÊ®°ÂûãÂõæÊ†áCSSÁ±ªÂêç
     */
    getModelIcon (iconName) {
      // Ê†πÊçÆSCMÂâçÁ´ØÁöÑÂõæÊ†áÁ≥ªÁªüÊù•Êò†Â∞Ñ
      const iconMap = {
        deepSeek: 'icon-deepseek',
        openAi: 'icon-openai',
        zhiPuAi: 'icon-zhipuai',
        qianFan: 'icon-qianfan',
        ollama: 'icon-ollama'
      }
      return iconMap[iconName] || 'icon-default'
    },

    /**
     * Ëé∑ÂèñÁ±ªÂûãÂêçÁß∞
     */
    getTypeName (item) {
      const typeOption = modelTypeOptions.find(e => e.value === item.type)
      return typeOption ? typeOption.label : item.type || '-'
    },

    /**
     * Ê£ÄÊü•ÊùÉÈôê
     */
    hasPermission () {
      // Ê†πÊçÆSCMÁöÑÊùÉÈôêÁ≥ªÁªüÊù•Ê£ÄÊü•ÊùÉÈôê
      // ËøôÈáåÂÖàËøîÂõûtrueÔºåÂÆûÈôÖÂ∫îËØ•Ê£ÄÊü•Áî®Êà∑ÊùÉÈôê
      return true
    }
  }
}
</script>

<style scoped>
.model-settings-dialog {
  min-height: 600px;
}

.model-settings-container {
  display: flex;
  height: 500px;
  border: 1px solid #e4e7ed;
  border-radius: 4px;
}

.model-list-wrapper {
  width: 200px;
  padding: 24px;
  border-right: 1px solid #e4e7ed;
  background-color: #fafafa;
}

.model-config-title {
  display: flex;
  align-items: center;
  font-weight: 500;
  margin-bottom: 16px;
}

.model-item {
  padding: 12px 16px;
  border: 1px solid transparent;
  cursor: pointer;
  margin-bottom: 4px;
}

.model-item:hover {
  background: #f5f5f5;
}

.model-item.active {
  border: 1px solid #409eff;
  color: #409eff;
  background: #ecf5ff;
}

.model-config-content {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.model-config-card-list-wrapper {
  flex: 1;
  overflow: hidden;
}

.model-config-card-list {
  padding: 16px;
  height: 100%;
  border-radius: 4px;
  background: #f5f5f5;
}

.model-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}

.model-card {
  border: 1px solid #e4e7ed;
  transition: all 0.3s;
}

.model-card:hover {
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
}

.model-item-img {
  border-radius: 4px;
  background: #f5f5f5;
  display: flex;
  align-items: center;
  justify-content: center;
}

.one-line-text {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.empty-state {
  position: absolute;
  left: 50%;
  top: 30%;
  transform: translate(-50%, -50%);
}
</style>
