# Feature Specification: AI Workflow 工作流功能迁移

**Feature Branch**: `001-ai-workflow-migration`
**Created**: 2025-10-21
**Status**: Draft
**Input**: User description: "将 aideepin 的应用（包括 workflow）逻辑完整迁移到 SCM 前端 70_ai 模块，包括所有窗体、API、常量等组件，严格按照原逻辑实现"

## Clarifications

### Session 2025-10-21

- Q: 工作流执行过程中调用外部服务（AI模型、知识库API、HTTP请求）失败时如何处理？ → A: 基于 aideepin 实际实现（HttpRequestNode.java, WorkflowEngine.java）：HTTP请求节点允许用户配置重试次数（0-10次）和超时时间（1-600秒），使用 Apache HttpClient 的 DefaultHttpRequestRetryHandler 自动重试。HTTP状态码非200时节点不抛出异常，而是输出错误内容继续执行。只有 IOException 等严重异常才会被 WorkflowEngine 捕获，通过 SSE 发送错误消息给客户端，并更新工作流状态为 FAIL（状态码4），记录错误详情到 statusRemark 字段。

- Q: 前端代码的目录结构和文件保存位置是什么？ → A: 所有工作流相关代码保存在 SCM 前端 70_ai 模块下：窗体vue组件在 `src/components/70_ai/components/workflow`，API服务在 `src/components/70_ai/api`，常量定义在 `src/components/70_ai/constants`，Vuex状态管理在 `src/components/70_ai/store`，工具函数在 `src/components/70_ai/utils`，样式文件在 `src/components/70_ai/styles`。

- Q: 工作流功能的UI入口在哪里？如何打开？ → A: 在 chat ai 弹窗中，"打开我的知识库"图标旁边增加一个新图标（workflow图标）作为工作流入口。点击后通过弹窗方式打开工作流页面。弹窗配置必须参考 `ItemEmbeddingDialog.vue` 的 el-dialog 属性：`:modal="true"`, `:close-on-click-modal="false"`, `:close-on-press-escape="false"`, `:show-close="false"`, `:append-to-body="true"`, `:modal-append-to-body="true"`, `width="900px"`, `destroy-on-close`, `top="5vh"`，并使用 `v-el-drag-dialog` 指令支持拖拽。

- Q: 节点之间数据传递的格式和结构是什么？ → A: 基于 aideepin 实际实现（NodeIOData.java, NodeIODataContent.java, WfIODataTypeEnum.java），节点间数据使用 JSON 对象格式传递，结构为 `{name: "参数名", content: {title: "显示标题", type: 整数类型码, value: 实际值}}`。type 字段标识数据类型，完整映射为：1=TEXT（文本）、2=NUMBER（数字）、3=OPTIONS（下拉选项）、4=FILES（文件列表）、5=BOOL（布尔值）、6=REF_INPUT（引用节点输入参数）、7=REF_OUTPUT（引用节点输出参数）。value 字段根据 type 可以是字符串、数字、布尔值、数组（List<String>）或对象（Map<String, Object>）。所有节点输入输出都使用 NodeIOData 结构，确保节点间互操作性。

- Q: 工作流画布可视化编辑器使用什么技术实现？ → A: aideepin 使用 @vue-flow/core v1.42.1 + @vue-flow/background v1.3.2（Vue 3 专用，不兼容 Vue 2.7）。SCM 前端将使用 **AntV X6** 作为替代方案。X6 是阿里蚂蚁集团开源的图编辑引擎，框架无关（支持 Vue 2/3、React），功能强大（支持节点拖拽、连线、自定义节点/边、事件系统、SVG/HTML 渲染等），性能优秀，且有完善的中文文档。需在实施规划阶段设计 X6 与 aideepin Vue Flow 功能的对应映射，确保保持相同的交互逻辑和用户体验。

- Q: 工作流执行时 SSE 推送的事件类型和消息格式是什么？ → A: 基于 aideepin 实际实现（SSEEmitterHelper.java, AdiConstant.java, WorkflowEngine.java），工作流执行时通过 SSE 推送以下事件：`[START]`（开始执行，数据为 WfRuntimeResp JSON）、`[NODE_RUN_{nodeUuid}]`（节点开始运行，数据为 WfRuntimeNodeDto JSON）、`[NODE_INPUT_{nodeUuid}]`（节点输入，数据为 NodeIOData JSON）、`[NODE_CHUNK_{nodeUuid}]`（节点流式输出块，用于 LLM 生成文本，数据为文本片段字符串）、`[NODE_OUTPUT_{nodeUuid}]`（节点输出，数据为 NodeIOData JSON）、`[NODE_WAIT_FEEDBACK_BY_{nodeUuid}]`（等待用户反馈，数据为提示文本）、`[DONE]`（执行完成）、`[ERROR]`（执行错误，数据为错误消息）。所有事件名使用方括号包裹，nodeUuid 动态替换为实际节点UUID。SSE 超时时间为 2.5 分钟（150秒）。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 创建和设计工作流 (Priority: P1)

作为 AI 平台用户，我需要通过可视化界面创建自定义工作流，以便自动化复杂的 AI 任务处理流程。

**Why this priority**: 这是工作流功能的核心价值，用户必须能够创建工作流才能使用其他功能。没有此功能，整个工作流模块无法运作。

**Independent Test**: 可以通过创建一个简单的两节点工作流（开始节点→回答节点）并保存来独立测试。用户能够成功保存并在列表中看到新建的工作流即视为成功。

**Acceptance Scenarios**:

1. **Given** 用户已登录 SCM 系统，**When** 用户点击"新建工作流"按钮，**Then** 系统显示工作流设计器界面，包含空白画布和节点选择器
2. **Given** 用户在设计器中，**When** 用户从节点库拖拽一个"LLM 回答"节点到画布，**Then** 节点出现在画布上，用户可以配置节点属性
3. **Given** 用户已添加多个节点，**When** 用户连接两个节点（开始→回答→结束），**Then** 系统显示连线，表示数据流向
4. **Given** 用户完成工作流设计，**When** 用户点击"保存"按钮，**Then** 系统保存工作流定义并返回工作流列表

---

### User Story 2 - 配置工作流节点 (Priority: P1)

作为工作流设计者，我需要详细配置每个节点的参数和行为，以便实现精确的业务逻辑。

**Why this priority**: 节点配置直接决定工作流的执行效果，是核心功能之一。无法配置节点则工作流无法正常运行。

**Independent Test**: 可以通过配置单个 LLM 节点（选择模型、设置提示词）并保存来独立测试。配置成功保存且在重新打开时保留配置即视为成功。

**Acceptance Scenarios**:

1. **Given** 用户选中画布上的节点，**When** 用户点击节点，**Then** 右侧属性面板显示该节点的所有可配置参数
2. **Given** 用户在 LLM 节点属性面板，**When** 用户选择AI模型并输入提示词模板，**Then** 配置立即生效并可预览
3. **Given** 用户在知识检索节点，**When** 用户选择知识库并设置检索参数（相似度阈值、最大结果数），**Then** 配置保存到节点定义中
4. **Given** 用户配置了多个节点，**When** 用户点击"测试运行"，**Then** 系统使用当前配置执行工作流并返回结果

---

### User Story 3 - 运行和调试工作流 (Priority: P1)

作为工作流使用者，我需要执行工作流并实时查看运行状态，以便验证工作流是否按预期工作。

**Why this priority**: 运行功能是工作流的最终目标，用户创建工作流就是为了执行。此功能缺失则工作流无法产生价值。

**Independent Test**: 可以通过运行一个简单的工作流（开始→LLM回答→结束）并查看执行结果来独立测试。工作流成功执行并显示结果即视为成功。

**Acceptance Scenarios**:

1. **Given** 用户查看已保存的工作流，**When** 用户点击"运行"按钮并提供必要的输入参数，**Then** 系统开始执行工作流并显示实时进度
2. **Given** 工作流正在运行，**When** 某个节点开始执行，**Then** 该节点在画布上高亮显示，并显示执行状态（进行中/成功/失败）
3. **Given** 工作流包含人工反馈节点，**When** 执行到该节点，**Then** 系统暂停并等待用户输入反馈内容
4. **Given** 工作流执行完成，**When** 用户查看运行记录，**Then** 系统显示完整的执行历史，包括每个节点的输入输出和执行时间

---

### User Story 4 - 管理工作流版本 (Priority: P2)

作为工作流管理员，我需要查看、复制和删除工作流，以便有效管理多个工作流实例。

**Why this priority**: 虽然不是最核心功能，但对于实际使用非常重要。用户需要管理多个工作流版本和实例。

**Independent Test**: 可以通过创建一个工作流，然后复制、重命名、删除来独立测试。所有管理操作成功执行即视为成功。

**Acceptance Scenarios**:

1. **Given** 用户在工作流列表页面，**When** 用户查看"我的工作流"标签，**Then** 系统显示用户创建的所有工作流，包括名称、创建时间、最后修改时间
2. **Given** 用户选中一个工作流，**When** 用户点击"复制"按钮，**Then** 系统创建该工作流的副本，名称为"[原名称]-副本"
3. **Given** 用户选中一个工作流，**When** 用户点击"删除"按钮并确认，**Then** 系统删除工作流并刷新列表
4. **Given** 用户查看公开工作流市场，**When** 用户搜索特定工作流，**Then** 系统显示匹配的公开工作流供用户复制使用

---

### User Story 5 - 使用高级节点类型 (Priority: P2)

作为高级用户，我需要使用专业节点（文档提取、关键词提取、HTTP请求等），以便构建复杂的业务自动化流程。

**Why this priority**: 高级节点扩展了工作流的能力边界，但不是所有用户都需要。P1功能足以满足基本需求。

**Independent Test**: 可以通过创建包含文档提取节点的工作流，上传PDF文档并提取内容来独立测试。成功提取文档内容并传递给下一节点即视为成功。

**Acceptance Scenarios**:

1. **Given** 用户设计工作流，**When** 用户添加"文档提取"节点并上传PDF文件，**Then** 节点提取文档文本内容供后续节点使用
2. **Given** 用户使用"关键词提取"节点，**When** 工作流执行到该节点，**Then** 系统使用LLM提取文本中的关键词并输出结构化数据
3. **Given** 用户配置"HTTP请求"节点，**When** 节点执行时，**Then** 系统发送HTTP请求到指定URL并获取响应数据
4. **Given** 用户使用"分类器"节点，**When** 节点执行时，**Then** 系统根据LLM分类结果将流程路由到不同的下游节点

---

### User Story 6 - 查看运行历史和调试 (Priority: P3)

作为工作流调试者，我需要查看详细的运行历史和节点执行日志，以便排查问题和优化工作流。

**Why this priority**: 调试功能很有用，但在MVP阶段可以通过查看运行结果来初步验证。详细的日志和调试工具可以在后期完善。

**Independent Test**: 可以通过运行一个包含错误的工作流（如错误的API配置），然后查看错误日志来独立测试。能够看到错误详情和堆栈信息即视为成功。

**Acceptance Scenarios**:

1. **Given** 用户查看工作流运行记录，**When** 用户点击某次运行记录，**Then** 系统显示该次运行的完整执行轨迹，包括每个节点的状态
2. **Given** 某个节点执行失败，**When** 用户点击失败的节点，**Then** 系统显示详细的错误信息和失败原因
3. **Given** 用户查看节点执行详情，**When** 用户展开节点输入输出，**Then** 系统显示该节点的完整输入数据和输出结果
4. **Given** 用户需要清理历史记录，**When** 用户点击"清空运行记录"，**Then** 系统删除所有历史运行数据但保留工作流定义

---

### Edge Cases

- 当用户创建的工作流包含循环引用（节点A→节点B→节点A）时，系统应检测并阻止保存，提示用户修正
- 当工作流运行时间超过5分钟时，系统应显示超时警告，并允许用户终止执行
- 当用户在工作流运行过程中删除该工作流时，系统应阻止删除操作并提示"工作流正在运行中，无法删除"
- 当节点配置缺少必填参数时（如LLM节点未选择模型），系统应在运行前验证并提示用户补全配置
- 当用户快速连续点击"保存"按钮时，系统应防止重复提交，显示"正在保存中"状态
- 当工作流包含知识检索节点但知识库为空时，系统应在执行时返回空结果并继续执行
- 当HTTP请求节点遇到网络错误时，系统应根据节点配置的重试次数（0-10次）使用 Apache HttpClient 的 DefaultHttpRequestRetryHandler 自动重试，超时时间由用户配置（1-600秒）。HTTP状态码非200时节点继续执行并输出错误内容，仅 IOException 等严重异常会标记工作流失败。
- 当浏览器离线时，用户应能查看已加载的工作流，但无法保存或运行新的工作流

## Requirements *(mandatory)*

### Functional Requirements

#### 工作流管理

- **FR-001**: 系统必须在 chat ai 弹窗中提供工作流功能入口，在"打开我的知识库"图标旁边显示 workflow 图标按钮
- **FR-002**: 点击 workflow 图标后，系统必须以弹窗方式打开工作流页面，弹窗配置包括：`:modal="true"`, `:close-on-click-modal="false"`, `:close-on-press-escape="false"`, `:show-close="false"`, `:append-to-body="true"`, `:modal-append-to-body="true"`, `width="900px"`, `destroy-on-close`, `top="5vh"`，并支持拖拽（`v-el-drag-dialog` 指令）
- **FR-003**: 系统必须允许用户创建新的工作流，包括设置工作流名称、描述和公开状态
- **FR-004**: 系统必须支持编辑现有工作流的基本信息（名称、描述、公开状态）
- **FR-005**: 系统必须支持复制现有工作流，创建副本供用户修改
- **FR-006**: 系统必须支持删除工作流，并在删除前要求用户确认
- **FR-007**: 系统必须支持将工作流设置为公开，允许其他用户查看和复制
- **FR-008**: 系统必须提供搜索功能，支持按名称或描述搜索用户的工作流和公开工作流

#### 工作流设计

- **FR-009**: 系统必须提供可视化画布，允许用户通过拖拽方式添加节点
- **FR-010**: 系统必须支持连接节点，通过连线表示数据流向
- **FR-011**: 系统必须提供节点库，包含以下节点类型：开始节点、结束节点、LLM回答节点、分类器节点、分支节点、模板节点、文档提取节点、关键词提取节点、FAQ提取节点、知识检索节点、HTTP请求节点、人工反馈节点、邮件发送节点、Google搜索节点、图像生成节点（Dalle3、通义万相）
- **FR-012**: 系统必须支持删除节点和连线
- **FR-013**: 系统必须支持移动节点位置以优化画布布局
- **FR-014**: 系统必须自动保存节点位置信息，用户重新打开时保持原有布局
- **FR-015**: 系统必须验证工作流的有效性（如：至少包含开始和结束节点、无孤立节点、无循环引用）

#### 节点配置

- **FR-016**: 系统必须为每个节点提供属性配置面板
- **FR-017**: LLM回答节点必须支持选择AI模型和配置提示词模板
- **FR-018**: 知识检索节点必须支持选择知识库、设置相似度阈值、最大结果数和严格模式
- **FR-019**: 分类器节点必须支持定义多个分类类别及其目标节点
- **FR-020**: 分支节点必须支持定义条件表达式和默认分支
- **FR-021**: HTTP请求节点必须支持配置请求方法、URL、请求头、请求体、超时时间（1-600秒）和重试次数（0-10次），使用 Apache HttpClient 的 DefaultHttpRequestRetryHandler 实现自动重试
- **FR-022**: 邮件发送节点必须支持配置收件人、主题、正文和SMTP服务器信息
- **FR-023**: 节点配置必须支持引用前序节点的输出作为输入参数（变量引用）
- **FR-024**: 系统必须验证节点配置的完整性，阻止保存配置不完整的工作流

#### 工作流执行

- **FR-025**: 系统必须支持运行工作流，接收用户提供的输入参数
- **FR-026**: 系统必须实时显示工作流执行状态，包括当前执行节点、已完成节点、失败节点
- **FR-027**: 系统必须以流式方式返回LLM节点的输出，实时显示生成内容
- **FR-028**: 系统必须支持人工反馈节点，在执行到该节点时暂停并等待用户输入
- **FR-029**: 系统必须支持恢复暂停的工作流，在用户提供反馈后继续执行
- **FR-030**: 系统必须记录每次工作流运行，保存输入、输出、执行时间和状态（状态码：READY=1, DOING=2, SUCCESS=3, FAIL=4, WAITING_INPUT=5）
- **FR-031**: 系统必须支持查询工作流运行历史，按时间倒序分页显示
- **FR-032**: 系统必须支持查看单次运行的详细信息，包括每个节点的输入输出和执行状态（节点状态码：READY=1, DOING=2, SUCCESS=3, FAIL=4）
- **FR-033**: 系统必须支持终止正在运行的工作流
- **FR-034**: 系统必须支持删除运行历史记录
- **FR-035**: 系统必须通过 SSE（Server-Sent Events）实时推送工作流执行进度和节点状态变化给客户端
- **FR-036**: 当工作流执行发生严重异常（如IOException）时，系统必须通过 SSE 发送错误消息，更新工作流状态为 FAIL，并将错误详情记录到 statusRemark 字段

#### 组件管理

- **FR-037**: 系统必须提供工作流组件库，列出所有可用的节点类型及其说明
- **FR-038**: 系统必须提供操作符列表，用于分支节点的条件判断（等于、不等于、大于、小于、包含等）

#### 数据持久化

- **FR-039**: 系统必须保存工作流定义，包括节点配置、连线关系和画布布局
- **FR-040**: 系统必须支持增量保存，仅提交变更的节点和连线
- **FR-041**: 系统必须使用乐观锁机制，防止并发编辑冲突
- **FR-042**: 系统必须支持删除已删除的节点和连线（软删除标记）

### Key Entities

- **工作流（Workflow）**: 代表一个自动化流程定义，包含名称、描述、是否公开、创建用户、创建时间等属性。包含多个节点和连线。

- **工作流节点（WorkflowNode）**: 工作流中的单个处理单元，包含节点类型、标题、输入配置、节点配置、输出配置、画布位置（X, Y坐标）等属性。每个节点关联一个工作流组件定义。

- **工作流边/连线（WorkflowEdge）**: 连接两个节点的线，定义数据流向，包含源节点UUID、源句柄ID、目标节点UUID等属性。

- **工作流组件（WorkflowComponent）**: 节点类型的定义，包含组件名称、标题、描述、是否启用等属性。系统预定义多种组件类型。

- **工作流运行时（WorkflowRuntime）**: 代表一次工作流执行实例，包含工作流UUID、输入参数、输出结果、执行状态（READY=1, DOING=2, SUCCESS=3, FAIL=4, WAITING_INPUT=5）、状态说明（statusRemark）、创建时间等属性。包含多个运行时节点记录。

- **工作流运行时节点（WorkflowRuntimeNode）**: 单个节点的执行记录，包含节点UUID、输入数据、输出数据、执行状态（READY=1, DOING=2, SUCCESS=3, FAIL=4）、状态说明（statusRemark）等属性。

- **节点输入输出定义（NodeIODefinition）**: 定义节点的输入输出参数，包含参数类型（文本、文件、选项等）、名称、标题、是否必填等属性。

- **节点配置（NodeConfig）**: 不同节点类型的特定配置，如LLM节点的模型名称和提示词、知识检索节点的知识库UUID和检索参数、HTTP请求节点的超时时间和重试次数等。

- **用户输入（UserInput）**: 运行工作流时用户提供的输入参数，包含参数名称、内容类型和值。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在5分钟内创建一个包含3个节点的简单工作流并成功运行
- **SC-002**: 系统支持单个工作流包含至少50个节点而不影响设计器性能（画布操作响应时间<200ms）
- **SC-003**: 工作流运行时，节点状态更新延迟不超过500ms，用户能够实时看到执行进度
- **SC-004**: 90%的工作流能在10秒内完成执行（不包含需要人工反馈的工作流）
- **SC-005**: 工作流保存成功率达到99.9%，异常情况下系统能提供明确的错误提示
- **SC-006**: 用户能够通过工作流实现至少80%的常见AI任务自动化需求（文本处理、知识检索、内容生成）
- **SC-007**: 公开工作流市场包含至少10个可复用的工作流模板，覆盖主流使用场景
- **SC-008**: 新用户能够在首次使用后10分钟内理解工作流的基本概念并成功创建第一个工作流（通过引导教程或示例）

## Assumptions

1. **技术栈兼容性**: 假设 Vue 2.7 的 Composition API 支持能够满足迁移 aideepin（Vue 3）代码的需求，或可以通过 Options API 适配
2. **图形化编辑器**: 使用 AntV X6 替代 aideepin 的 @vue-flow/core，假设 X6 能够实现 Vue Flow 的所有核心功能（节点拖拽、连线、自定义节点/边、事件系统等），并保持相同的用户体验
3. **后端API就绪**: 假设 SCM 后端已经实现或将同步实现所有必要的 workflow 相关接口（如未实现，需要额外的后端开发时间）
4. **数据格式一致**: 假设 SCM 后端的数据模型与 aideepin 后端基本一致，前端迁移后可直接对接
5. **SSE流式支持**: 假设 SCM 项目现有的 SSE 工具（sseUtils.js）可以复用于工作流运行的流式返回
6. **用户权限**: 假设 SCM 系统已有用户认证和权限管理机制，工作流模块可以集成现有权限体系
7. **知识库集成**: 假设知识检索节点可以调用 SCM 已实现的知识库API，无需额外开发
8. **AI模型集成**: 假设 SCM 已集成AI模型服务，工作流可以直接调用LLM、图像生成等模型
9. **性能要求**: 假设工作流运行在云端服务器，客户端无需担心复杂计算导致的性能问题
10. **浏览器兼容性**: 假设目标用户使用现代浏览器（Chrome、Edge、Firefox 最新版本），不需要支持IE或旧版浏览器
11. **HTTP客户端库**: 假设前端可以使用 Axios 或类似库实现与 aideepin 后端 Apache HttpClient 的 DefaultHttpRequestRetryHandler 相似的重试机制

## Constraints

1. **无实现细节**: 本规格不涉及具体的技术实现方案、代码结构或框架选择，这些属于实施计划的范畴
2. **迁移范围限制**: 仅迁移 aideepin 前端的工作流相关功能，不包括其他AI功能（如对话、绘图等，这些已由其他模块负责）
3. **代码完整性要求**: 迁移的代码必须保持功能完整性，不得因代码长度而简化或省略任何功能逻辑
4. **原有逻辑保留**: 必须严格遵循 aideepin 的原有业务逻辑和交互流程，不得随意修改或重新设计
5. **中文系统**: SCM 系统是中文系统，所有用户界面文本、提示信息使用中文
6. **Element UI 组件库**: 必须使用 Element UI 组件库，不得引入其他UI框架
7. **无移动端优化**: 当前版本聚焦PC端体验，不要求移动端响应式适配
8. **数据安全**: 工作流数据（包括配置和运行记录）必须遵循 SCM 系统的数据安全规范，支持租户隔离
9. **目录结构约束**: 所有工作流相关代码必须保存在 SCM 前端 `src/components/70_ai` 模块下的指定子目录中：
   - Vue组件：`src/components/70_ai/components/workflow/`
   - API服务：`src/components/70_ai/api/`
   - 常量定义：`src/components/70_ai/constants/`
   - Vuex状态管理：`src/components/70_ai/store/`
   - 工具函数：`src/components/70_ai/utils/`
   - 样式文件：`src/components/70_ai/styles/`
